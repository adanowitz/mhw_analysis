---
title: "PostCovidDataAnalysis"
author: "Daniel DeFoe"
date: "8/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(MASS)
library(tidyverse)
library(kimisc)
library(checkmate)
library(ggplot2)
library(Hmisc)
library(zoo)
library(stats)
library(flipPlots)
library(tidyverse)
library(tidytext)
library(kableExtra)
library(formattable)
library(htmltools)
library(webshot)
#install.packages("magick")
#webshot::install_phantomjs()


```

```{r, include=FALSE}
export_formattable <- function(f, file, width = "100%", height = NULL, 
                               background = "white", delay = 0.2)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay)
    }
```


```{r}
data = read.csv("postCovidDataWScreenings.csv")
```

```{r}
data$gender = relevel(data$gender, "Male")
data$race= relevel(data$race, "White")
data$public_private = relevel(data$public_private, "public")
data$sexuality = relevel(data$sexuality, "Heterosexual")
data$us_international = relevel(data$us_international, "us")
data$armed_forces = relevel(data$armed_forces, "No")
data$parents_edu = relevel(data$parents_edu, "Bachelorâ€™s degree")
```




## Initial Data Summaries
Demographic breakdown is as follows. 
Race
```{r}
data %>% 
  group_by(race) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```

Gender
```{r}
data %>% 
  group_by(gender) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```
Sexuality
```{r}
data %>% 
  group_by(sexuality) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```

MH condition
```{r}
data %>% 
  group_by(mhw_condition) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```

Parents' education
```{r}
data %>% 
  group_by(parents_edu) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```
Public or private school
```{r}
data %>% 
  group_by(public_private) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) 
```


Us or international
```{r}
data %>% 
  group_by(us_international) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```


Armed Forces
```{r}
data %>% 
  group_by(armed_forces) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```


Number of unique schools
```{r}
data %>%
  select(university) %>%
  unique() %>%
  count()
```



Function to get the top N stress issues experience. 
```{r}
top_n_stressors = function(data, n){
  data_sub = data %>%
    select(c("death_spouse":"eating_change")) #Grabs only the changing stress experiences columns
  data_sub = data.frame(data_sub)
  data_sub = plyr::ldply(data.frame(data_sub), function(x) sum(x != 0)) %>% 
    rename(experience=.id, freq = V1) %>%
    arrange(desc(freq)) %>%
    head(n)
  
  return(data_sub)
}

```




```{r}
experience_freq = top_n_stressors(data, 50) %>%
  arrange(desc(freq))

experience_freq$experience = factor(experience_freq$experience, levels = experience_freq$experience)

ggplot(experience_freq, aes(x = experience, y = freq)) + 
  theme(axis.text.x = element_text(angle = 45, hjust=1, size = 11)) + 
  geom_bar(stat="identity") + 
  labs(title = "Frequency of Different Experiences Students Have Had Post-Covid", x = "Experience", y = "Freq")
```



Here is the number of screenings we got for each mh condition. 

```{r}
colSums(!is.na(data[,c("kessler_major", "kessler_moderate", "dep_major","dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd")]))
```






## Stress Score by Demographic Analysis
```{r}
#This will be the dataset that we do statistical tests on unless grouping by us_international,  profit_nonprofit or twoYear_fourYear
test_data = data%>%
  filter(us_international == "us" & profit_nonprofit == "nonprofit" & twoYear_fourYear == 4 & eng_undergrad == "Yes")

```


```{r}
twoYear_test_data = data%>%
  filter(us_international == "us" & profit_nonprofit == "nonprofit" & twoYear_fourYear == 2 & eng_undergrad == "Yes")
```

Distribution of all new stress scores. 
```{r}
ggplot(test_data, aes(x=new_stress)) +
  geom_histogram() + 
  labs(title = "Distribution of New Stress Scores", x = "New Stress Score", y = "Freq")
```


Distribution of new stress scores by gender. 
```{r}
test_data_gender = test_data %>%
  filter(gender == "Male" | gender == "Female")
ggplot(test_data_gender, aes(x=new_stress)) +
  geom_histogram() + 
  labs(title = "Distribution of New Stress Scores By Gender", x = "New Stress Score", y = "Freq") +
  facet_grid(gender ~ .) +
  theme(strip.text.y = element_text(size=6, angle=0))
```

Distribution of all new stress scores by race. 
```{r}
ggplot(test_data, aes(x=new_stress)) +
  geom_histogram() + 
  labs(title = "Distribution of New Stress Scores By Race", x = "New Stress Score", y = "Freq") +
  facet_grid(race ~ .)+
  theme(strip.text.y = element_text(size=6, angle=0))
```


A linear regression model predicting new stress with some demographic variables. (using only 4 year, us, nonprofits)
```{r}
data_sub= test_data %>% 
  dplyr::select(c("gender", "age", "race", "mhw_condition", "mhw_in_treatment", "sexuality", "international", "parents_edu", "public_private", "armed_forces", "learning_dis", "physical_dis", "year_in_program", "new_stress")) %>%
  na.omit()

model = lm(new_stress ~ gender + age + race + mhw_condition + mhw_in_treatment + sexuality + international + parents_edu + public_private + armed_forces + learning_dis + physical_dis + year_in_program,data =data_sub)
step_model = stepAIC(model, direction = "both", trace = FALSE)
summary(step_model)
```




The following function will let us see the distribution of the numeric "new_stress" score by a grouping variable of our choice.
```{r}
visualize_new_stress_dist = function(data, groups){
  ggplot(data = data, aes_string(x = groups, y = "new_stress", fill = groups)) + 
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Distributions of New Stress by ", groups), y="New Stress Score", x = capitalize(groups), fill =capitalize(groups))
}
```



```{r}
data_sub_gender = test_data %>%
  filter(gender == "Male" | gender=="Female")

t.test(new_stress ~ gender,data = data_sub_gender)
visualize_new_stress_dist(data_sub_gender, "gender")
```


The p-value suggests that there is not evidence of a significant difference in new stress between males and females.


```{r}
t.test(new_stress ~ public_private,data = test_data)
visualize_new_stress_dist(data, "public_private")
```

The p-value suggests that there is strong evidence of a significant difference in new stress between students at public and private schools.


```{r}
internatonal_data = test_data %>%
  filter(international == "Yes" | international=="No")
t.test(new_stress ~ international,data = internatonal_data)
visualize_new_stress_dist(internatonal_data , "international")
```

The p-value suggests that there is strong evidence of a significant difference in new stress between students at in the US and international students.



```{r}
data_sub_mhw_condition= test_data %>%
  filter(mhw_condition == "Yes" | mhw_condition == "No")

t.test(new_stress ~ mhw_condition,data = data_sub_mhw_condition)
visualize_new_stress_dist(data_sub_mhw_condition, "mhw_condition")
```


The p-value suggests that there is strong evidence of a significant difference in new stress between students with and without mh conditions.



```{r}
race_anova = aov(new_stress ~ race, data = test_data)
summary(race_anova)

TukeyHSD(race_anova)
visualize_new_stress_dist(test_data, "race")
```

Pairwise Significant 
-Hispanic or Latino-American Indian or Alaska Native  
- Other (please specify)-American Indian or Alaska Native   
- Hispanic or Latino-Asian  
- Other (please specify)-Asian 
- Other (please specify)-Black or African American   
- White-Hispanic or Latino   
- White-Other (please specify)    

```{r}
sexuality_anova = aov(new_stress ~ sexuality, data = test_data)
summary(sexuality_anova)

TukeyHSD(sexuality_anova)
visualize_new_stress_dist(test_data, "sexuality")
```

Nothing was significant here.


```{r}
year_anova = aov(new_stress ~ year_in_program, data = test_data)
summary(year_anova)

TukeyHSD(year_anova)
visualize_new_stress_dist(test_data, "year_in_program")
```

Very little evidence of any significant differences here. 


## General Analysis of Diagnoses + New Stress by Demographic

This gives an output analyzing the different screenings by a chosen demographic. 
```{r}
process_grouped = function(data, var){
  grouped = data %>%
    group_by_(var) %>%
    select(c("kessler_major", "kessler_moderate", "dep_major", "dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd", "new_stress")) %>%
    summarise_all(mean, na.rm=TRUE)
  
  grouped_diagnosis = grouped %>%
    select(-new_stress)%>%
    gather(key = "diagnosis", "proportion", 2:10)
  
  grouped_stress = grouped %>%
    select(var, new_stress)
  
  plot1 = ggplot(data = grouped_diagnosis, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = diagnosis), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Proportion of respondents of each ", var, " with each MH Diagnosis"), x = capitalize(var), y = "Proportion")
  
  print(plot1)
  
  plot2 = ggplot(data = grouped_stress, aes_string(x = var, y = "new_stress")) +
    geom_bar(stat="identity")+ 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Average New Stress of Respondents by  ", var), x = capitalize(var), y = "Average New Stress Score")
    
  print(plot2)
  
  return(grouped_stress)
}
```

```{r message=FALSE}
process_grouped(test_data, "race")
```


```{r}
process_grouped(test_data, "gender")
```

```{r}
process_grouped(test_data, "sexuality")
```

```{r}
process_grouped(test_data, "public_private")
```

```{r}
process_grouped(test_data, "mhw_condition")
```

```{r}
process_grouped(test_data, "mhw_in_treatment")
```



```{r}
test_data %>%
  group_by(mhw_condition, mhw_in_treatment) %>%
  select(c("kessler_major", "kessler_moderate", "dep_major", "dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd", "new_stress")) %>%
  summarise_all(mean, na.rm=TRUE)
```



## Regressions Predicting Covid Experiences
```{r message=FALSE}
firstcol = which(colnames(test_data)=="death_spouse")
lastcol = which(colnames(test_data)=="eating_change")
covid_experiences = names(test_data[, c(firstcol:lastcol)])
model_data = test_data %>%
  select(age, gender, race, sexuality, mhw_condition, c("death_spouse":"eating_change")) %>%
  mutate_each(function(x) ifelse(x!=0, 1, 0), c("death_spouse":"eating_change")) 


varnames = names(model_data)[6:30]
fit = lapply(varnames, 
    FUN=function(x) glm(formula(paste(x, "~age + race + gender + sexuality + mhw_condition")), family=binomial(link='logit'), data=model_data))
names(fit) <- varnames


predictor_names = names(which(summary(fit$death_spouse)$coeff[-1,4] >0))
group_sig_dif = data.frame(predictor_of_experience = predictor_names, 
                           Stat_More_Likely = rep("", length(predictor_names)),
                           Stat_Less_Likely = rep("", length(predictor_names)), 
                           stringsAsFactors = F)


for (m in fit){
  print(paste("Response of below model is experiencing", names(m$model)[1]))
  test_sum = summary(m)
  print(test_sum)

  more_likely = names(which(test_sum$coeff[-1,4] < 0.05 & test_sum$coeff[-1,1] > 0))
  less_likely = names(which(test_sum$coeff[-1,4] < 0.05 & test_sum$coeff[-1,1] < 0))
  for (v in more_likely){
    group_sig_dif$Stat_More_Likely[group_sig_dif$predictor == v] = paste(group_sig_dif$Stat_More_Likely[group_sig_dif$predictor == v],",\n", names(m$model)[1])
  }
  
  for (v in less_likely){
    group_sig_dif$Stat_Less_Likely[group_sig_dif$predictor == v] = paste(group_sig_dif$Stat_Less_Likely[group_sig_dif$predictor == v],",\n", names(m$model)[1])
  }
  
}


#group_sig_dif$Stat_More_Likely = substring(group_sig_dif$Stat_More_Likely, first = 4)
#group_sig_dif$Stat_Less_Likely =substring(group_sig_dif$Stat_Less_Likely, first = 4)
group_sig_dif$Stat_More_Likely =gsub("^.{0,4}", "", group_sig_dif$Stat_More_Likely)
group_sig_dif$Stat_Less_Likely =gsub("^.{0,4}", "", group_sig_dif$Stat_Less_Likely)
group_sig_dif

```


```{r}
to_black = formatter("span", style ="color:black;white-space: pre-line")
group_sig_dif$predictor_of_experience = to_black(group_sig_dif$predictor_of_experience)
group_sig_dif$Stat_More_Likely = to_black(group_sig_dif$Stat_More_Likely)
group_sig_dif$Stat_Less_Likely = to_black(group_sig_dif$Stat_Less_Likely)

line_split = function(x){renderFormattable(x)}

names(group_sig_dif)= to_black(names(group_sig_dif))

obj =formattable(group_sig_dif, align = c("l","c", "c"))
export_formattable(obj, "many_reg_results.png")
```








## Analysis of Depression Major or Other
```{r}
depression_analysis = function(data, var){
  grouped = data %>%
    group_by_(var) %>%
    select(c("dep_major", "dep_other")) %>%
    mutate(dep_any = ifelse(dep_major ==1 |dep_other ==1, 1, 0)) %>%
    summarise_all(mean, na.rm=TRUE)
  
  grouped = grouped %>%
    gather(key = "diagnosis", "proportion", 2:4)
  
  plot1 = ggplot(data = grouped, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = diagnosis), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Proportion of respondents of each ", var, " with Any Depression Diagnosis"), x = capitalize(var), y = "Proportion")
  
  print(plot1)
  
  return(grouped)

}
```

```{r}
depression_analysis(test_data, "race")
```




## Food and Housing Security
```{r}
food_housing_security_analysis = function(data, var){
  grouped_housing = data %>%
    group_by_(var, "housing_security_situation") %>%
    summarise(n = n()) %>%
    mutate(proportion = n/sum(n)) 
  
  
  grouped_food = data %>%
    group_by_(var, "food_security_situation") %>%
    summarise(n = n()) %>%
    mutate(proportion = n/sum(n)) 
  
  
  
  plot1 = ggplot(data = grouped_housing, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = str_wrap(housing_security_situation, 30)), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1),  legend.text=element_text(size=9)) + 
    labs(title = paste("Proportion of respondents of each ", var, " Housing Security Situation"), x = capitalize(var), y = "Proportion")+
    scale_fill_discrete(name = "Housing Security")
  
  print(plot1)
  
  plot2 = ggplot(data = grouped_food, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = str_wrap(food_security_situation, 30)), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1),  legend.text=element_text(size=9)) + 
    labs(title = paste("Proportion of respondents of each ", var, " Food Security Situation"), x = capitalize(var), y = "Proportion")+
    scale_fill_discrete(name = "Food Security")
  
  print(plot2)
  
  return(grouped_housing)

}

```


```{r}
food_housing_security_analysis(test_data, "race")
```


```{r}
food_housing_security_analysis(test_data, "gender")
```



```{r}
tab_data = table(test_data$food_security_situation, test_data$gender)
tab2_data = table(test_data$housing_security_situation, test_data$gender)
print("Housing Security by Gender")
chisq.test(tab_data)
print("Food Security by Gender")
chisq.test(tab2_data)

```


```{r}
tab_data = table(test_data$food_security_situation, test_data$race)
tab2_data = table(test_data$housing_security_situation, test_data$race)
print("Housing Security by Race")
chisq.test(tab_data)
print("Food Security by Race")
chisq.test(tab2_data)
```

```{r}
tab_data = table(test_data$food_security_situation, test_data$parents_edu)
tab2_data = table(test_data$housing_security_situation, test_data$parents_edu)
print("Housing Security by Parents Edu")
chisq.test(tab_data)
print("Food Security by Parents Edu")
chisq.test(tab2_data)
```

```{r}
tab_data = table(test_data$food_security_situation, test_data$international)
tab2_data = table(test_data$housing_security_situation, test_data$international)
print("Housing Security by International Student")
chisq.test(tab_data)
print("Food Security by International Student")
chisq.test(tab2_data)
```

```{r}
tab_data = table(test_data$food_security_situation, test_data$sexuality)
tab2_data = table(test_data$housing_security_situation, test_data$sexuality)
print("Housing Security by Sexuality")
chisq.test(tab_data)
print("Food Security by Sexuality")
chisq.test(tab2_data)
```

```{r}
tab_data = table(test_data$food_security_situation, test_data$mhw_condition)
tab2_data = table(test_data$housing_security_situation, test_data$mhw_condition)
print("Housing Security by MH Condition")
chisq.test(tab_data)
print("Food Security by MH Condition")
chisq.test(tab2_data)
```

```{r}
tab_data = table(test_data$food_security_situation, test_data$public_private)
tab2_data = table(test_data$housing_security_situation, test_data$public_private)
print("Housing Security by Public Private")
chisq.test(tab_data)
print("Food Security by Public Private")
chisq.test(tab2_data)
```


```{r}

housing_food = test_data %>%
  group_by(housing_security_situation, food_security_situation)%>%
  summarise(n = n()) %>%
  rename(housing = housing_security_situation, food = food_security_situation)

print(housing_food)
SankeyDiagram(housing_food[, c(-3)],
              link.color = "Source", 
              font.size = 7,
              label.show.counts = TRUE,
              weights = housing_food$n) 
```


## Access Quesitons
```{r}
access_to_instruction_analysis = function(data, var){
  grouped_access_to_materials = data %>%
    group_by_(var, "access_to_instruction_course_materials_situation") %>%
    summarise(n = n()) %>%
    mutate(proportion = n/sum(n)) 
  
  
  
  plot1 = ggplot(data = grouped_access_to_materials, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = str_wrap(access_to_instruction_course_materials_situation, 30)), position = "dodge", stat="identity") + 
    labs(title = paste("Proportion of respondents of each ", var, " \nAccess to Instruction Course Materials Situation"), x = capitalize(var), y = "Proportion")+
    scale_fill_discrete(name = "Access to Instruction") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),  legend.text=element_text(size=9)) 
  
  print(plot1)
  
  return(grouped_access_to_materials)

}
```

```{r}
access_to_instruction_analysis(test_data, "race")
```



## Comorbidity
### Covid Experiences 
Correlation matrix of covid stress experiences.
```{r}
firstcol = which(colnames(test_data)=="death_spouse")
lastcol = which(colnames(test_data)=="eating_change")
covid_experiences = test_data[, c(firstcol:lastcol)] %>%
  mutate_all(function(x) ifelse(x!=0, 1, 0))
cor(covid_experiences)
```


This function takes a vector of covid stress experiences as strings, and will output a bar graph for respondents who experienced all things in the input list, what proportion experienced each other stress experience. Your qualifying experiences could be singluar or a vector. 
```{r}
comorbid_covid_exp_with= function(var){
  experienced = count(covid_experiences %>%
  filter(., rowSums(.[var])==length(var)))$n
  
  var_data = covid_experiences %>%
  filter(., rowSums(.[var])==length(var)) %>%
  select(-var) %>%
  gather(key = "diagnosis", value = "value") %>%
  group_by(diagnosis) %>%
  summarise(proportion = sum(value, na.rm = TRUE)/count(covid_experiences %>%
  filter(rowSums(.[var]) == length(var)))$n)
  
  plot = ggplot(var_data, aes(x = reorder(diagnosis,-proportion), y = proportion)) + 
    geom_bar(stat="identity") + 
    labs(title = paste("Proportion of Respondents Who Experienced Each Situation \nWho Also Experienced '", var, "'"), x = "Stress Experience") +
    theme(axis.text.x = element_text(angle = 45, hjust=1), plot.title = element_text(size=12, hjust = 0.5))
  
  print(plot)
  return(paste(experienced, " respondents experienced ", paste0(var, collapse = ", ")))
}
```

```{r}
comorbid_covid_exp_with(c("eating_change", "take_loan", "social_change"))
```

```{r}
comorbid_covid_exp_with("social_change")
```


```{r}
comorbid_covid_exp_with("death_family")
```










### MH Diagnoses

We'll make 2 tables to try to group the conditions with multiple and exclusive categories. 
Table 1:
```{r}
firstcol = which(colnames(data)=="kessler_major")
lastcol = which(colnames(data)=="ptsd")
mhdiagnoses = data[, c(firstcol:lastcol)]
mhdiagnoses = mhdiagnoses[complete.cases(mhdiagnoses), ]
cor(mhdiagnoses)
formattable(as.data.frame(cor(mhdiagnoses)), list(formatter("span"),
  `metric` = formatter("span", style = ~ style(color = "grey",font.weight = "bold","border-radius" = "0px")), 
                     area(col = -1) ~ function(x) percent(x / 100, digits = 0),
                     area(col = -1) ~ function(x)ifelse(x<=0, color_tile("red", "transparent")(x*c(x<=0)), 
                                    color_tile("transparent", "forest green")(x*c(x>=0)))))
```

Table 2: 
```{r}
firstcol = which(colnames(test_data)=="kessler_major")
lastcol = which(colnames(test_data)=="ptsd")
mhdiagnoses_all = test_data[, c(firstcol:lastcol)] %>%
  mutate(dep_any = ifelse(dep_major ==1 |dep_other ==1, 1, 0)) %>%
  mutate(anx_any = ifelse(other_anxiety ==1 |panic ==1, 1, 0)) %>%
  mutate(kessler_any = ifelse(kessler_major ==1 |kessler_moderate ==1, 1, 0)) %>%
  select(-c("dep_major", "dep_other", "other_anxiety", "panic", "kessler_major", "kessler_moderate"))
mhdiagnoses =mhdiagnoses_all[complete.cases(mhdiagnoses_all), ]
cor(mhdiagnoses)
```

```{r}
comorbid_diagnosis_with= function(var){
  var_data = mhdiagnoses_all %>%
  filter(.[var] == 1) %>%
  select(-var) %>%
  gather(key = "diagnosis", value = "value") %>%
  group_by(diagnosis) %>%
  summarise(proportion = sum(value, na.rm = TRUE)/count(mhdiagnoses_all %>%
  filter(.[var] == 1))$n)
  
  ggplot(var_data, aes(x = reorder(diagnosis, -proportion), y = proportion)) + 
    geom_bar(stat="identity") + 
    labs(title = paste("Proportion of Respondents With Different MH Diagnoses Who had '", var, "'"))
}

```


```{r}
comorbid_diagnosis_with("dep_any")
```

```{r}
comorbid_diagnosis_with("bin_eat")
```


```{r}
comorbid_diagnosis_with("anx_any")
```

```{r}
comorbid_diagnosis_with("bulimia")
```

```{r}
comorbid_diagnosis_with("ptsd")
```

```{r}
comorbid_diagnosis_with("kessler_any")
```




## Predicting MH Screenings Using the COVID New Stress
Looking at predicting the MH Screenings using the COVID "new_stress" variable. 


```{r message=FALSE}
test_data = test_data %>%
  mutate(dep_any = ifelse(dep_major ==1 |dep_other ==1, 1, 0)) %>%
  mutate(anx_any = ifelse(other_anxiety ==1 |panic ==1, 1, 0)) %>%
  mutate(kessler_any = ifelse(kessler_major ==1 |kessler_moderate ==1, 1, 0))


diagnoses_names = names(test_data[, c("kessler_major", "kessler_moderate", "dep_major", "dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd", "dep_any", "anx_any", "kessler_any")])
model_data = test_data %>%
  select(age, gender, race, sexuality, mhw_condition, c("kessler_major":"kessler_any")) %>%
  mutate_each(function(x) ifelse(x!=0, 1, 0), c("kessler_major", "kessler_moderate", "dep_major","dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd", "dep_any", "anx_any", "kessler_any")) 



fit = lapply(diagnoses_names, 
    FUN=function(x) glm(formula(paste(x, "~age + race + sexuality + mhw_condition + new_stress")), family=binomial(link='logit'), data=model_data))
names(fit) <- diagnoses_names


predictor_names = names(which(summary(fit$kessler_major)$coeff[-1,4] >0))
print(predictor_names)

group_sig_dif = data.frame(predictor = predictor_names, 
                           Stat_More_Likely = rep("", length(predictor_names)),
                           Stat_Less_Likely = rep("", length(predictor_names)), 
                           stringsAsFactors = F)


for (m in fit){
  print(paste("Response of below model is experiencing", names(m$model)[1]))
  test_sum = summary(m)
  print(test_sum)

  more_likely = names(which(test_sum$coeff[-1,4] < 0.05 & test_sum$coeff[-1,1] > 0))
  less_likely = names(which(test_sum$coeff[-1,4] < 0.05 & test_sum$coeff[-1,1] < 0))
  for (v in more_likely){
    group_sig_dif$Stat_More_Likely[group_sig_dif$predictor == v] = paste(group_sig_dif$Stat_More_Likely[group_sig_dif$predictor == v],",", names(m$model)[1])
  }
  
  for (v in less_likely){
    group_sig_dif$Stat_Less_Likely[group_sig_dif$predictor == v] = paste(group_sig_dif$Stat_Less_Likely[group_sig_dif$predictor == v],",", names(m$model)[1])
  }
  
}
group_sig_dif$Stat_More_Likely =gsub("^.{0,2}", "", group_sig_dif$Stat_More_Likely)
group_sig_dif$Stat_Less_Likely =gsub("^.{0,2}", "", group_sig_dif$Stat_Less_Likely)
group_sig_dif
```

It seems that an increase in new_stress is associated with greater likelihood of screening positive for each of the mental health diagnoses. 






## Free Response Analysis
We can analyze here at a basic level what respondents are talking about in their text responses. 
```{r}
removeSpecialChars =function(text){
  return (gsub("[^a-zA-Z0-9 ]", " ", text))
}


getWordCounts = function(question) {
  question = as.character(question)
  tidy = tibble(question) %>%
    mutate(responseNum = row_number()) %>%
    unnest_tokens(word, question) %>%
    anti_join(stop_words) %>%
    filter(complete.cases(.)) %>%
    count(word, sort = TRUE)
    
  return(tidy)
}

```


```{r}
getWordCounts(test_data$cope_strategies_free_response)
```

```{r}
getWordCounts(test_data$university_mental_health_not_supportive_in_pandemic)
```

```{r}
getWordCounts(test_data$wish_university_did_in_pandemic_mental_health)
```

```{r}
getWordCounts(test_data$wish_university_resources_provided_pandemic_mental_health)
```

















































