---
title: "PostCovidDataAnalysis"
author: "Daniel DeFoe"
date: "8/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(kimisc)
library(checkmate)
library(ggplot2)
library(Hmisc)
library(zoo)
library(stats)
```


```{r}
data = read.csv("postCovidDataWScreenings.csv")
```

```{r}
data$gender = relevel(data$gender, "Male")
data$race= relevel(data$race, "White")
data$public_private = relevel(data$public_private, "public")
data$sexuality = relevel(data$sexuality, "Heterosexual")
data$us_international = relevel(data$us_international, "us")
data$armed_forces = relevel(data$armed_forces, "No")
data$parents_edu = relevel(data$parents_edu, "Bachelorâ€™s degree")
```



## Initial Data Summaries
Demographic breakdown is as follows. 
Race
```{r}
data %>% 
  group_by(race) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```

Gender
```{r}
data %>% 
  group_by(gender) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```
Sexuality
```{r}
data %>% 
  group_by(sexuality) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```

MH condition
```{r}
data %>% 
  group_by(mhw_condition) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```

Parents' education
```{r}
data %>% 
  group_by(parents_edu) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```
Public or private school
```{r}
data %>% 
  group_by(public_private) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) 
```


Us or international
```{r}
data %>% 
  group_by(us_international) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```


Armed Forces
```{r}
data %>% 
  group_by(armed_forces) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  drop_na()
```


Number of unique schools
```{r}
data %>%
  select(university) %>%
  unique() %>%
  count()
```



Function to get the top N stress issues experience. 
```{r}
top_n_stressors = function(data, n){
  data_sub = data %>%
    select(c("death_spouse":"eating_change")) #Grabs only the changing stress experiences columns
  data_sub = data.frame(data_sub)
  data_sub = plyr::ldply(data.frame(data_sub), function(x) sum(x != 0)) %>% 
    rename(experience=.id, freq = V1) %>%
    arrange(desc(freq)) %>%
    head(n)
  
  return(data_sub)
}

```




```{r}
experience_freq = top_n_stressors(data, 50) %>%
  arrange(desc(freq))

experience_freq$experience = factor(experience_freq$experience, levels = experience_freq$experience)

ggplot(experience_freq, aes(x = experience, y = freq)) + 
  theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
  geom_bar(stat="identity") + 
  labs(title = "Frequency of Different Experiences Students have had Post-Covid")
```



Here is the number of screenings we got for each mh condition. 

```{r}
colSums(!is.na(data[,c("kessler_major", "kessler_moderate", "dep_major","dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd")]))
```






## Stress Score by Demographic Analysis
```{r}
#This will be the dataset that we do statistical tests on unless grouping by us_international,  profit_nonprofit or twoYear_fourYear
test_data = data%>%
  filter(us_international == "us" & profit_nonprofit == "nonprofit" & twoYear_fourYear == 4 & eng_undergrad == "Yes")

```

Distribution of all new stress scores. 
```{r}
ggplot(test_data, aes(x=new_stress)) +
  geom_histogram() + 
  labs(title = "Distribution of New Stress Scores")
```


Distribution of new stress scores by gender. 
```{r}
ggplot(test_data, aes(x=new_stress)) +
  geom_histogram() + 
  labs(title = "Distribution of New Stress Scores By Gender") +
  facet_grid(gender ~ .) +
  theme(strip.text.y = element_text(size=6, angle=0))
```

Distribution of all new stress scores by race. 
```{r}
ggplot(test_data, aes(x=new_stress)) +
  geom_histogram() + 
  labs(title = "Distribution of New Stress Scores By Race") +
  facet_grid(race ~ .)+
  theme(strip.text.y = element_text(size=6, angle=0))
```

A linear regression model predicting new stress with some demographic variables. (using only 4 year, us, nonprofits)
```{r}
model = lm(new_stress ~ gender + age + race + mhw_condition + mhw_in_treatment ,data =test_data)
summary(model)
```




The following function will let us see the distribution of the numeric "new_stress" score by a grouping variable of our choice.
```{r}
visualize_new_stress_dist = function(data, groups){
  ggplot(data = data, aes_string(x = groups, y = "new_stress", fill = groups)) + 
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Distributions of New Stress by ", groups), y="New Stress Score", x = capitalize(groups), fill =capitalize(groups))
}
```



```{r}
data_sub_gender = test_data %>%
  filter(gender == "Male" | gender=="Female")

t.test(new_stress ~ gender,data = data_sub_gender)
visualize_new_stress_dist(data_sub_gender, "gender")
```


The p-value suggests that there is not evidence of a significant difference in new stress between males and females.


```{r}
t.test(new_stress ~ public_private,data = data)
visualize_new_stress_dist(data, "public_private")
```

The p-value suggests that there is strong evidence of a significant difference in new stress between students at public and private schools.


```{r}
t.test(new_stress ~ us_international,data = data)
visualize_new_stress_dist(data, "us_international")
```

The p-value suggests that there is strong evidence of a significant difference in new stress between students at in the US and international students.



```{r}
data_sub_mhw_condition= test_data %>%
  filter(mhw_condition == "Yes" | mhw_condition == "No")

t.test(new_stress ~ mhw_condition,data = data_sub_mhw_condition)
visualize_new_stress_dist(data_sub_mhw_condition, "mhw_condition")
```


The p-value suggests that there is strong evidence of a significant difference in new stress between students with and without mh conditions.



```{r}
race_anova = aov(new_stress ~ race, data = test_data)
summary(race_anova)

TukeyHSD(race_anova)
visualize_new_stress_dist(test_data, "race")
```

Pairwise Significant 
-Hispanic or Latino-American Indian or Alaska Native  
- Other (please specify)-American Indian or Alaska Native   
- Hispanic or Latino-Asian  
- Other (please specify)-Asian 
- Other (please specify)-Black or African American   
- White-Hispanic or Latino   
- White-Other (please specify)    

```{r}
sexuality_anova = aov(new_stress ~ sexuality, data = test_data)
summary(sexuality_anova)

TukeyHSD(sexuality_anova)
visualize_new_stress_dist(test_data, "sexuality")
```

Nothing was significant here.


```{r}
year_anova = aov(new_stress ~ year_in_program, data = test_data)
summary(year_anova)

TukeyHSD(year_anova)
visualize_new_stress_dist(test_data, "year_in_program")
```

Very little evidence of any significant differences here. 


## General Analysis of Diagnoses by Demographic

This gives an output analyzing the different screenings by a chosen demographic. 
```{r}
process_grouped = function(data, var){
  grouped = data %>%
    group_by_(var) %>%
    select(c("kessler_major", "kessler_moderate", "dep_major", "dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd", "new_stress")) %>%
    summarise_all(mean, na.rm=TRUE)
  
  grouped_diagnosis = grouped %>%
    select(-new_stress)%>%
    gather(key = "diagnosis", "proportion", 2:10)
  
  grouped_stress = grouped %>%
    select(var, new_stress)
  
  plot1 = ggplot(data = grouped_diagnosis, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = diagnosis), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Proportion of respondents of each ", var, " with each MH Diagnosis"), x = capitalize(var), y = "Proportion")
  
  print(plot1)
  
  plot2 = ggplot(data = grouped_stress, aes_string(x = var, y = "new_stress")) +
    geom_bar(stat="identity")+ 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Average New Stress of Respondents by  ", var), x = capitalize(var), y = "Average New Stress Score")
    
  print(plot2)
  
  return(grouped_stress)
}
```

```{r message=FALSE}
process_grouped(data, "race")
```


```{r}
process_grouped(data, "gender")
```

```{r}
process_grouped(data, "sexuality")
```

```{r}
process_grouped(data, "public_private")
```

```{r}
process_grouped(data, "us_international")
```

```{r}
process_grouped(data, "mhw_condition")
```

```{r}
process_grouped(data, "mhw_in_treatment")
```



```{r}
data %>%
  group_by(mhw_condition, mhw_in_treatment) %>%
  select(c("kessler_major", "kessler_moderate", "dep_major", "dep_other", "panic", "other_anxiety", "bulimia", "bin_eat", "ptsd", "new_stress")) %>%
  summarise_all(mean, na.rm=TRUE)
```


## Correlations between Covid Expereinces
Correlation matrix of covid stress experiences.
```{r}
firstcol = which(colnames(data)=="death_spouse")
lastcol = which(colnames(data)=="eating_change")
covid_experiences = data[, c(firstcol:lastcol)] %>%
  mutate_all(function(x) ifelse(x!=0, 1, 0))
cor(covid_experiences)
```



## Regressions Predicting Covid Experiences
```{r message=FALSE}
firstcol = which(colnames(data)=="death_spouse")
lastcol = which(colnames(data)=="eating_change")
covid_experiences = names(data[, c(firstcol:lastcol)])
model_data = test_data %>%
  select(age, gender, race, sexuality, mhw_condition, c("death_spouse":"eating_change")) %>%
  mutate_each(function(x) ifelse(x!=0, 1, 0), c("death_spouse":"eating_change")) 


varnames = names(model_data)[6:30]
fit = lapply(varnames, 
    FUN=function(x) glm(formula(paste(x, "~age + race + sexuality + mhw_condition")), family=binomial(link='logit'), data=model_data))
names(fit) <- varnames


predictor_names = names(which(summary(fit$death_spouse)$coeff[-1,4] >0))
group_sig_dif = data.frame(predictor = predictor_names, 
                           Stat_More_Likely = rep("", length(predictor_names)),
                           Stat_Less_Likely = rep("", length(predictor_names)), 
                           stringsAsFactors = F)


for (m in fit){
  print(paste("Response of below model is experiencing", names(m$model)[1]))
  test_sum = summary(m)
  print(test_sum)

  more_likely = names(which(test_sum$coeff[-1,4] < 0.05 & test_sum$coeff[-1,1] > 0))
  less_likely = names(which(test_sum$coeff[-1,4] < 0.05 & test_sum$coeff[-1,1] < 0))
  for (v in more_likely){
    group_sig_dif$Stat_More_Likely[group_sig_dif$predictor == v] = paste(group_sig_dif$Stat_More_Likely[group_sig_dif$predictor == v],",", names(m$model)[1])
  }
  
  for (v in less_likely){
    group_sig_dif$Stat_Less_Likely[group_sig_dif$predictor == v] = paste(group_sig_dif$Stat_Less_Likely[group_sig_dif$predictor == v],",", names(m$model)[1])
  }
  
}
group_sig_dif$Stat_More_Likely =gsub("^.{0,2}", "", group_sig_dif$Stat_More_Likely)
group_sig_dif$Stat_Less_Likely =gsub("^.{0,2}", "", group_sig_dif$Stat_Less_Likely)
group_sig_dif
```






## Analysis of Depression Major or Other
```{r}
depression_analysis = function(data, var){
  grouped = data %>%
    group_by_(var) %>%
    select(c("dep_major", "dep_other")) %>%
    mutate(dep_any = ifelse(dep_major ==1 |dep_other ==1, 1, 0)) %>%
    summarise_all(mean, na.rm=TRUE)
  
  grouped = grouped %>%
    gather(key = "diagnosis", "proportion", 2:4)
  
  plot1 = ggplot(data = grouped, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = diagnosis), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
    labs(title = paste("Proportion of respondents of each ", var, " with Any Depression Diagnosis"), x = capitalize(var), y = "Proportion")
  
  print(plot1)
  
  return(grouped)

}


```

```{r}
depression_analysis(data, "race")
```




## Food and Housing Security
```{r}
food_housing_security_analysis = function(data, var){
  grouped_housing = data %>%
    group_by_(var, "housing_security_situation") %>%
    summarise(n = n()) %>%
    mutate(proportion = n/sum(n)) 
  
  
  grouped_food = data %>%
    group_by_(var, "food_security_situation") %>%
    summarise(n = n()) %>%
    mutate(proportion = n/sum(n)) 
  
  
  
  plot1 = ggplot(data = grouped_housing, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = str_wrap(housing_security_situation, 30)), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1),  legend.text=element_text(size=9)) + 
    labs(title = paste("Proportion of respondents of each ", var, " Housing Security Situation"), x = capitalize(var), y = "Proportion")+
    scale_fill_discrete(name = "Housing Security")
  
  print(plot1)
  
  plot2 = ggplot(data = grouped_food, aes_string(x = var, y = "proportion")) + 
    geom_bar(aes(fill = str_wrap(food_security_situation, 30)), position = "dodge", stat="identity") + 
    theme(axis.text.x = element_text(angle = 45, hjust=1),  legend.text=element_text(size=9)) + 
    labs(title = paste("Proportion of respondents of each ", var, " Food Security Situation"), x = capitalize(var), y = "Proportion")+
    scale_fill_discrete(name = "Food Security")
  
  print(plot2)
  
  return(grouped_housing)

}

```


```{r}
food_housing_security_analysis(data, "race")
```


```{r}
housing_food = data %>%
  group_by(housing_security_situation, food_security_situation)%>%
  summarise(n = n()) %>%
  rename(housing = housing_security_situation, food = food_security_situation)

print(housing_food)
SankeyDiagram(housing_food[, c(-3)],
              link.color = "Source", 
              font.size = 8,
              weights = housing_food$n) 
```








































